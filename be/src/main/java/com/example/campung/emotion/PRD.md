# PRD: 캠퍼스 감정 날씨 (Campus Emotion Weather) v1.3 (Final)

## 1. 개요 (Introduction)

### 1.1. 문서 목적
본 문서는 'Campung' 애플리케이션의 **메인 화면에 '캠퍼스 감정 날씨' 기능을 통합**하기 위한 최종 요구사항을 정의합니다. 백엔드는 **여러 게시글을 배치(Batch) 단위로 묶어 효율적으로 감정을 분석**하고, 그 결과를 기존 메인 화면 조회 API 응답에 포함시켜 제공하는 것을 목표로 합니다.

### 1.2. 문제 정의 (Problem Statement)
사용자는 캠퍼스 커뮤니티의 전반적인 분위기를 직관적으로 파악할 수 있는 기능이 필요합니다. 이를 위해 별도의 API 호출 없이, 앱의 첫 화면인 메인 화면에 자연스럽게 분위기 정보를 노출시켜 사용자 경험을 증진시키고자 합니다.

### 1.3. 제안 기능 (Proposed Feature)
**매시간, 최근 1시간 동안 작성된 게시글**을 배치 단위로 묶어 AI(GPT)에 전달하여 감정 점수 총합을 계산합니다. 백엔드는 이 결과를 당일 누적 데이터에 합산하여 최종적으로 커뮤니티의 분위기를 **'날씨'**와 **'온도'**로 변환하고, 이 값을 **메인 화면 조회 API의 응답 데이터에 추가**하여 클라이언트에 전달합니다. 데이터는 매일 새벽 5시에 초기화됩니다.

---

## 2. 목표 (Goals and Objectives)

* **핵심 목표:** 사용자가 앱의 메인 화면에서 캠퍼스 커뮤니티의 전반적인 분위기를 즉시, 그리고 재미있게 파악하도록 돕는다.
* **세부 목표:**
    * 메인 화면의 정보성을 강화하고 감성적인 요소를 추가하여 사용자 경험(UX)을 향상시킨다.
    * 커뮤니티의 활기, 침체 등의 상태를 시각적으로 전달하여 사용자의 소속감과 공감대를 증진시킨다.
    * API 호출 횟수와 토큰 사용량을 최적화하여 비용 효율적인 방식으로 기능을 안정적으로 운영한다.

---

## 3. 기능 요구사항 (Functional Requirements)

### 3.1. 데이터 수집 및 처리 주기
* **FR-1 (주기적 실행):** 시스템은 **매시간 정각**에 감정 분석 프로세스를 자동으로 실행해야 한다. (예: 06:00, 07:00, 08:00...)
* **FR-2 (데이터 범위):** 매시간 실행 시, **직전 1시간 동안 작성된 모든 게시글(`Content`)**을 분석 대상으로 조회해야 한다. (예: 07:00에 실행 시, 06:00:00 ~ 06:59:59에 작성된 게시글 조회)
* **FR-3 (데이터 초기화):** 모든 누적 감정 점수는 **매일 새벽 5시(05:00)**에 초기화되어야 한다.

### 3.2. 감정 분석 및 점수 누적 (백엔드 내부 처리)
* **FR-4 (감정 분석):** 조회된 각 게시글에 대해, 사전에 정의된 6가지 감정('우울함', '밝음', '신남', '화남', '슬픔', '흥분된') 점수를 1~100점 척도로 측정해야 한다.
* **FR-5 (배치 처리 방식):** API 호출 비용과 토큰을 절약하기 위해, **여러 게시글을 하나의 배치로 묶어 단일 API 요청으로 처리**하는 것을 원칙으로 한다.
* **FR-6 (배치 분할 요청):** 시간당 게시글의 수가 많아 토큰 제한을 초과할 위험이 있을 경우(예: **30개 초과 시**), 게시글 목록을 **30개 단위의 배치로 분할하여 여러 번의 API 요청**을 보내야 한다.
* **FR-7 (GPT 프롬프트 및 응답 형식):** GPT가 여러 게시글을 한 번에 처리하고 **점수를 합산하여 반환**하도록 아래와 같이 프롬프트를 설계해야 한다.
    * **GPT 프롬프트 예시:**
        ```
        너는 여러 게시글의 감정을 동시에 분석하고 종합하는 전문가다.
        아래 목록의 각 게시글을 읽고 6가지 감정('우울함', '밝음', '신남', '화남', '슬픔', '흥분된')에 대해 1점에서 100점 사이로 점수를 매겨라.

        모든 게시글의 분석이 끝나면, 각 감정별 점수를 **모두 합산한 최종 누적 점수**를 아래 JSON 형식으로만 응답해라. 개별 게시글의 점수는 절대 포함하지 마라.

        [게시글 목록]
        1.
        title: {post1.title}
        content: {post1.content}

        2.
        title: {post2.title}
        content: {post2.content}

        ...

        [JSON 형식]
        {"우울함": <총합 점수>, "밝음": <총합 점수>, "신남": <총합 점수>, "화남": <총합 점수>, "슬픔": <총합 점수>, "흥분된": <총합 점수>}
        ```
* **FR-8 (점수 누적):** 매시간 API로부터 반환된 감정별 총합 점수는 Redis에 저장된 **당일의 총 누적 점수에 합산**되어야 한다. (배치를 분할 요청한 경우, 각 배치 결과를 모두 합산해야 함)

### 3.3. '날씨' 및 '온도' 변환 로직 (백엔드 내부 처리)
* **FR-9 (날씨 변환):** 누적된 감정 점수 분포에 따라 그날의 '감정 날씨'를 결정해야 한다. (로직은 v1.2와 동일)
* **FR-10 (온도 변환):** 게시글의 활력 수준(에너지)에 따라 '감정 온도'를 결정해야 한다. (로직은 v1.2와 동일)

### 3.4. 메인 화면 API 응답 수정
* **FR-11:** 기존 **메인 화면 조회 API**의 응답 DTO(Data Transfer Object)에 **현재 '감정 날씨'와 '감정 온도'를 나타내는 필드를 추가**해야 한다.
    * **수정 대상 API (예시):** `GET /api/v1/main`
    * **추가될 필드:**
        * `emotionWeather` (String): "화창함", "구름 낌" 등의 날씨 상태
        * `emotionTemperature` (Double): 28.5, 15.2 등의 온도 값
    * **수정 후 응답 Body 예시:**
        ```json
        {
          "success": true,
          "data": {
            "emotionWeather": "화창함",
            "emotionTemperature": 28.5
          }
        }
        ```

---

## 4. 기술 구현 방안 (Technical Implementation)

### 4.1. 아키텍처
* **스케줄러 (`@Scheduled`):**
    * **감정 분석 스케줄러:** 매시간 정각(`0 0 * * * *`)에 `CampusEmotionService`의 분석 및 누적 로직을 호출한다.
    * **데이터 초기화 스케줄러:** 매일 새벽 5시(`0 0 5 * * *`)에 Redis의 누적 점수 데이터를 초기화한다.
* **서비스 계층:**
    * `CampusEmotionService`: 시간별 게시글 조회, **게시글 목록을 배치로 분할 및 프롬프트 문자열 생성**, GPT API 호출, 응답받은 총합 점수를 Redis에 누적 저장하는 로직을 담당한다.
    * `MainService` (또는 메인 화면 로직을 담당하는 기존 서비스): 메인 화면 데이터 구성 시, Redis에서 현재의 '감정 날씨'와 '감정 온도'를 조회하여 최종 응답 DTO에 포함시킨다.
* **데이터 저장소:**
    * **MariaDB:** 분석 대상이 되는 원본 게시글(`Content`)을 조회한다.
    * **Redis:** 당일 누적 감정 점수, 최종 계산된 날씨(`emotionWeather`), 온도(`emotionTemperature`)를 저장하는 캐시 저장소로 활용한다.

---

## 5. 성공 지표 (Success Metrics)

* **정량적 지표:**
    * 메인 화면 이탈률 감소
    * 앱 재방문율 및 체류 시간 증가
* **정성적 지표:**
    * 사용자 피드백 및 앱 리뷰에서 기능에 대한 긍정적인 언급량
    * 소셜 미디어에서의 기능 언급 및 공유 빈도

---

## 6. 향후 개선 사항 (Future Considerations)

* **감정 세분화:** 기본 6가지 감정 외에 '기대감', '불안함' 등 캠퍼스 생활과 밀접한 감정을 추가하여 분석의 깊이를 더한다.
* **시간대별 분석:** 하루 전체 누적 데이터와 함께, 오전/오후/저녁 등 시간대별 감정 날씨를 제공하여 동적인 변화를 보여준다.
* **비용 최적화:** 기능 안정화 이후, `gpt-5-mini`와 같은 더 저렴한 모델로도 충분한 성능이 나오는지 테스트하여 운영 비용을 최적화한다.