name: CI CD Process

on:
  push:
    branches: [ develop, main ]  # developê³¼ main ë¸Œëœì¹˜ë§Œ ë°°í¬
  pull_request:
    branches: [ develop, main ]  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle Wrapper
      uses: gradle/actions/wrapper-validation@v3
      
    - name: Debug and fix gradlew
      run: |
        echo "=== ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ ==="
        ls -la
        echo "=== be ë””ë ‰í† ë¦¬ ë‚´ìš© ==="
        ls -la be/
        echo "=== gradlew íŒŒì¼ ìƒì„¸ ì •ë³´ ==="
        cd be
        ls -la gradlew* || echo "gradlew íŒŒì¼ë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        echo "=== gradlew íŒŒì¼ íƒ€ì… ==="
        file gradlew || echo "gradlew íŒŒì¼ íƒ€ì… í™•ì¸ ì‹¤íŒ¨"
        echo "=== gradlew ì²« ì¤„ í™•ì¸ ==="
        head -1 gradlew || echo "gradlew ì²« ì¤„ ì½ê¸° ì‹¤íŒ¨"
        echo "=== ë¼ì¸ ì—”ë”© ìˆ˜ì • ==="
        sed -i 's/\r$//' gradlew
        echo "=== ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ==="
        chmod +x gradlew
        echo "=== ìˆ˜ì • í›„ gradlew ìƒíƒœ ==="
        ls -la gradlew
        file gradlew
        echo "=== gradlew ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ==="
        ./gradlew --version || echo "gradlew ì‹¤í–‰ ì‹¤íŒ¨"
      
    - name: Run tests
      run: cd be && ./gradlew clean test
      
    - name: Build application
      run: cd be && ./gradlew build -x test
      
    - name: Build status
      run: |
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          echo "âœ… develop ë¸Œëœì¹˜ ë¹Œë“œ ì™„ë£Œ - ë°°í¬ ì—†ì´ í…ŒìŠ¤íŠ¸/ë¹Œë“œë§Œ ìˆ˜í–‰ë¨"
        else
          echo "âœ… PR í…ŒìŠ¤íŠ¸/ë¹Œë“œ ì™„ë£Œ"
        fi

  deploy:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: 119.56.208.5
        username: kjh
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22222
        script_stop: true
        script: |
          cd /home/kjh/Project/Campung_Backend
          
          echo "ğŸš€ ìš´ì˜ ì„œë²„ ë°°í¬ ì‹œì‘: ${{ github.ref_name }} ë¸Œëœì¹˜"
          echo "ğŸ“¦ ë°°í¬ íƒ€ì…: ${{ github.event_name }}"
          
          git fetch origin
          CURRENT_BRANCH=$(git branch --show-current)
          TARGET_BRANCH="${{ github.ref_name }}"
          if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
            echo "ë¸Œëœì¹˜ ë³€ê²½: $CURRENT_BRANCH â†’ $TARGET_BRANCH"
            git checkout $TARGET_BRANCH
          fi
          git pull origin $TARGET_BRANCH
        
          cd be
          echo "gradlew ìƒíƒœ í™•ì¸..."
          sed -i 's/\r$//' gradlew
          chmod +x gradlew
          ./gradlew --version || { echo "âŒ gradlew ì‹¤í–‰ ì‹¤íŒ¨"; exit 1; }
          
          ./gradlew clean build -x test
          
          # systemctl ê´€ë ¨ ìˆ˜ì • (daemon-reload ì¶”ê°€)
          echo "systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          sudo systemctl daemon-reload
          sudo systemctl restart campung-backend || { echo "âŒ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨"; exit 1; }
          
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 100
          
          for i in {1..12}; do
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ë‹µ í™•ì¸ ì™„ë£Œ ($((i*5))ì´ˆ í›„)"
              break
            else
              echo "ëŒ€ê¸° ì¤‘... ($((i*5))ì´ˆ)"
              sleep 5
            fi
          done
          
          echo "Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          DOCKER_CONTAINERS=$(docker ps --format "{{.Names}}" 2>/dev/null || echo "")
          
          if echo "$DOCKER_CONTAINERS" | grep -q "Campung" || true; then
            echo "âœ… MariaDB ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
          else
            echo "âš ï¸ MariaDB ì»¨í…Œì´ë„ˆ í™•ì¸ í•„ìš”"
          fi
          
          if echo "$DOCKER_CONTAINERS" | grep -q "campung-redis" || true; then
            echo "âœ… Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
          else
            echo "âš ï¸ Redis ì»¨í…Œì´ë„ˆ í™•ì¸ í•„ìš”"
          fi
          
          echo "ìµœì¢… ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          if curl -f http://localhost:8080/ > /dev/null 2>&1; then
            echo "âœ… ìµœì¢… í™•ì¸: ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹¤í–‰"
            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ìµœì¢… í™•ì¸ ì‹¤íŒ¨: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŒ"
            sudo systemctl status campung-backend --no-pager
            exit 1
          fi
          
          if systemctl is-active --quiet campung-backend; then
            echo "âœ… systemd ì„œë¹„ìŠ¤ ìƒíƒœ: ì •ìƒ"
          else
            echo "âš ï¸ systemd ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ í•„ìš”"
          fi
