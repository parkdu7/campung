name: CI CD Process

on:
  push:
    branches: [ develop, main ]  # develop과 main 브랜치만 배포
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: 119.56.208.5
        username: kjh
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22222
        script_stop: true
        script: |
          cd /home/kjh/Project/Campung_Backend
          
          # 현재 푸시된 브랜치 정보 출력
          echo "🚀 배포 시작: ${{ github.ref_name }} 브랜치"
          
          # 현재 브랜치 확인 및 업데이트 (강제 체크아웃 제거!)
          git fetch origin
          
          # 현재 브랜치가 푸시된 브랜치와 다르면 체크아웃
          CURRENT_BRANCH=$(git branch --show-current)
          TARGET_BRANCH="${{ github.ref_name }}"
          
          if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
            echo "브랜치 변경: $CURRENT_BRANCH → $TARGET_BRANCH"
            git checkout $TARGET_BRANCH
          fi
          
          git pull origin $TARGET_BRANCH
          ./gradlew clean build -x test
          sudo systemctl restart campung-backend
          sleep 15
          
          # Docker 컨테이너 상태 확인
          if ! docker ps | grep -q "Campung.*mariadb\|campung-redis.*redis"; then
            echo "⚠️ Docker 컨테이너 상태 확인 필요"
            echo "MariaDB, Redis 컨테이너가 실행 중인지 확인하세요:"
            echo "cd /home/kjh/Project/DB_Setting/campung && docker-compose ps"
          fi
          
          # 배포 상태 확인
          if systemctl is-active --quiet campung-backend; then
            echo "✅ 배포 성공: 서비스가 정상적으로 실행 중입니다."
            # 간단한 헬스체크
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "✅ 애플리케이션 응답 정상"
            else
              echo "⚠️ 애플리케이션 응답 확인 필요"
            fi
          else
            echo "❌ 배포 실패: 서비스 상태를 확인해주세요."
            sudo systemctl status campung-backend
            exit 1
          fi
