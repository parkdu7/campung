name: CI CD Process

on:
  push:
    branches: [ develop, main ]  # develop과 main 브랜치만 배포
  pull_request:
    branches: [ develop, main ]  # PR 생성/업데이트 시에도 실행
  workflow_dispatch:

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run tests
      run: ./gradlew clean test
      
    - name: Build application
      run: ./gradlew build -x test
      
    - name: Build status
      run: |
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          echo "✅ develop 브랜치 빌드 완료 - 배포 없이 테스트/빌드만 수행됨"
        else
          echo "✅ PR 테스트/빌드 완료"
        fi

  deploy:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: 119.56.208.5
        username: kjh
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22222
        script_stop: true
        script: |
          cd /home/kjh/Project/Campung_Backend
          
          # 현재 푸시된 브랜치 정보 출력
          echo "🚀 운영 서버 배포 시작: ${{ github.ref_name }} 브랜치"
          echo "📦 배포 타입: ${{ github.event_name }}"
          
          # 현재 브랜치 확인 및 업데이트 (강제 체크아웃 제거!)
          git fetch origin
          
          # 현재 브랜치가 푸시된 브랜치와 다르면 체크아웃
          CURRENT_BRANCH=$(git branch --show-current)
          TARGET_BRANCH="${{ github.ref_name }}"
          
          if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
            echo "브랜치 변경: $CURRENT_BRANCH → $TARGET_BRANCH"
            git checkout $TARGET_BRANCH
          fi
          
          git pull origin $TARGET_BRANCH
        
          # be 디렉토리로 이동
          cd be
          
          # gradlew 실행 권한 부여 (서버에서 필요)
          chmod +x gradlew

          
          ./gradlew clean build -x test
          sudo systemctl restart campung-backend
          sleep 15
          
          # Docker 컨테이너 상태 확인
          MARIADB_RUNNING=$(docker ps --filter "name=Campung" --format "{{.Names}}" | grep -c "^Campung$" || echo "0")
          REDIS_RUNNING=$(docker ps --filter "name=campung-redis" --format "{{.Names}}" | grep -c "^campung-redis$" || echo "0")
          
          if [ "$MARIADB_RUNNING" -eq "0" ] || [ "$REDIS_RUNNING" -eq "0" ]; then
            echo "⚠️ Docker 컨테이너 상태 확인 필요"
            echo "MariaDB 실행 상태: $MARIADB_RUNNING, Redis 실행 상태: $REDIS_RUNNING"
            echo "컨테이너를 시작하려면: cd /home/kjh/Project/DB_Setting/campung && docker-compose up -d"
          else
            echo "✅ Docker 컨테이너 정상 실행 중 (MariaDB, Redis)"
          fi
          
          # 배포 상태 확인
          if systemctl is-active --quiet campung-backend; then
            echo "✅ 배포 성공: 서비스가 정상적으로 실행 중입니다."
            # 간단한 헬스체크
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "✅ 애플리케이션 응답 정상"
            else
              echo "⚠️ 애플리케이션 응답 확인 필요"
            fi
          else
            echo "❌ 배포 실패: 서비스 상태를 확인해주세요."
            sudo systemctl status campung-backend
            exit 1
          fi
